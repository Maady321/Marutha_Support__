<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Doctor Dashboard - Marutha Support</title>
    
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <header>
        <h1>Doctor Dashboard</h1>
        <nav>
            <span id="userName" style="margin-right: 1rem; font-weight: bold;"></span>
            <button onclick="logout()" class="btn" style="background: #e74c3c;">Logout</button>
        </nav>
    </header>

    <div class="container">
        <div id="loading">Loading...</div>
        <div id="content" style="display:none;">

            
            <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Status: </strong> <span id="docStatus">Offline</span>
                </div>
                <div>
                    <button id="btnStatus" class="btn" onclick="toggleStatus()">Go Online</button>
                    <a href="assign_volunteer.html" class="btn" style="background:var(--secondary);">Assign
                        Volunteer</a>
                </div>
            </div>

            
            <div class="card">
                <h2>Pending Consultation Requests</h2>
                <div id="requestList"></div>
            </div>

            <div class="card">
                <h2>My Patients</h2>
                <div id="patientsList"></div>
            </div>

            <div class="card">
                <h2>Consultation Requests (Traditional)</h2>
                <div id="consultationList"></div>
            </div>

            
            <div class="card">
                <h2>Chat</h2>
                <div class="form-group">
                    <label>Chat with Patient:</label>
                    <select id="chatRecipient" onchange="changeChatPartner()" style="padding: 0.5rem;">
                        <option value="">Select Patient...</option>
                    </select>
                </div>
                <div class="chat-box" id="chatBox"></div>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="chatMsg" placeholder="Type a message..." style="flex:1;">
                    <button onclick="sendChat()" class="btn">Send</button>
                </div>
            </div>

        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        let doctorId = null;
        let userId = null;
        let ws = null;

        // ---------------------------------------------------------
        // MEANING: Init.
        // EXPLAIN: "Load profile, check auth, start WebSocket."
        // ---------------------------------------------------------
        async function init() {
            const user = await checkAuth();
            if (!user || user.role !== 'doctor') {
                window.location.href = "../login.html";
                return;
            }
            userId = user.id;
            document.getElementById('userName').textContent = "Dr. " + user.email;

            // Find Profile
            const res = await apiFetch("/doctors/");
            const doctors = await res.json();
            const myProfile = doctors.find(d => d.user_id === userId);

            if (myProfile) {
                doctorId = myProfile.id;
                loadPatients();
                loadConsultations();
                loadRequests();
                setupWebSocket();
                updateStatusUIFromProfile(myProfile);
            } else {
                alert("Doctor profile not found.");
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        function updateStatusUIFromProfile(p) {
            isOnline = p.is_online;
            updateStatusUI();
        }

        // ---------------------------------------------------------
        // MEANING: Load Patients.
        // EXPLAIN: "Fetch patients assigned to this doctor."
        // ---------------------------------------------------------
        async function loadPatients() {
            const res = await apiFetch(`/doctors/${doctorId}/patients`);
            const patients = await res.json();

            const div = document.getElementById('patientsList');
            const sel = document.getElementById('chatRecipient');

            div.innerHTML = "";
            // Clear Select but keep first option
            sel.innerHTML = '<option value="">Select Patient...</option>';

            patients.forEach(p => {
                // List UI
                const item = document.createElement('div');
                item.className = "patient-card";
                item.innerHTML = `
                    <strong>${p.name}</strong> (Age: ${p.age}, Stage: ${p.stage})
                    <button class="btn action-btn" onclick="updateStage(${p.id})">Update Stage</button>
                    <button class="btn action-btn" onclick="viewDetails(${p.id})">Details</button>
                    <button class="btn action-btn" style="background:var(--secondary);" onclick="viewReports(${p.id})">Reports</button>
                    <button class="btn action-btn" style="background:#8e44ad;" onclick="viewVitals(${p.id})">Vitals</button>
                `;
                div.appendChild(item);

                // Chat Select UI
                const opt = document.createElement('option');
                opt.value = p.user_id;
                opt.textContent = `${p.name} (ID: ${p.id})`;
                sel.appendChild(opt);
            });
        }

        async function updateStage(pid) {
            const newStage = prompt("Enter new stage (early, mid, late, critical):");
            if (newStage) {
                await apiFetch(`/patients/${pid}`, {
                    method: "PUT",
                    body: JSON.stringify({ stage: newStage })
                });
                loadPatients();
            }
        }

        async function viewDetails(pid) {
            const res = await apiFetch(`/patients/${pid}`);
            const p = await res.json();
            alert(`Name: ${p.name}\nAge: ${p.age}\nStage: ${p.stage}`);
        }

        // ---------------------------------------------------------
        // MEANING: View Reports Modal.
        // EXPLAIN: "Dynamic modal creation for viewing patient files."
        // ---------------------------------------------------------
        async function viewReports(pid) {
            const res = await apiFetch(`/reports/patient/${pid}`);
            const reports = await res.json();

            let html = `<div style="padding:1rem;"><h3>Patient Reports</h3><ul>`;
            if (reports.length === 0) html += "<li>No reports found.</li>";
            else {
                reports.forEach(r => {
                    html += `<li><a href="/${r.file_path}" target="_blank">${r.title}</a></li>`;
                });
            }
            html += `</ul><button class="btn" style="margin-top:1rem; background: #6b7280;" onclick="closeModal()">Close</button></div>`;

            const modal = document.createElement('div');
            modal.id = 'reportModal';
            modal.style.position = 'fixed';
            modal.style.top = '0'; modal.style.left = '0';
            modal.style.width = '100%'; modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)'; // Darker overlay
            modal.style.display = 'flex'; modal.style.justifyContent = 'center'; modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const content = document.createElement('div');
            // Solid Dark Theme
            content.style.background = '#1f2937';
            content.style.border = '1px solid #4b5563';
            content.style.padding = '2rem';
            content.style.borderRadius = '8px';
            content.style.minWidth = '300px';
            content.style.color = 'white';
            content.style.maxHeight = '80vh'; content.style.overflowY = 'auto';
            content.innerHTML = html;

            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        async function viewVitals(pid) {
            const res = await apiFetch(`/vitals/patient/${pid}`);
            const logs = await res.json();

            let html = `<div style="padding:1rem;"><h3>Patient Vitals History</h3>`;
            html += `<table style="width:100%; border-collapse:collapse; margin-top:1rem;">
                        <thead><tr style="border-bottom:1px solid #777;">
                            <th style="text-align:left;">Date</th>
                            <th style="text-align:left;">Pain (1-10)</th>
                            <th style="text-align:left;">Mood</th>
                            <th style="text-align:left;">Notes</th>
                        </tr></thead><tbody>`;

            if (logs.length === 0) html += "<tr><td colspan='4'>No vitals logged.</td></tr>";
            else {
                logs.forEach(l => {
                    html += `<tr>
                        <td>${new Date(l.timestamp).toLocaleString()}</td>
                        <td>${l.pain_level}</td>
                        <td>${l.mood}</td>
                        <td>${l.notes || '-'}</td>
                    </tr>`;
                });
            }
            html += `</tbody></table>
                     <button class="btn" style="margin-top:1rem; background: #6b7280;" onclick="closeModal()">Close</button></div>`;

            const modal = document.createElement('div');
            modal.id = 'reportModal'; // Reusing ID for simplicity, or create vitalsModal
            modal.style.position = 'fixed';
            modal.style.top = '0'; modal.style.left = '0';
            modal.style.width = '100%'; modal.style.height = '100%';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex'; modal.style.justifyContent = 'center'; modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const content = document.createElement('div');
            content.style.background = '#1f2937';
            content.style.border = '1px solid #4b5563';
            content.style.padding = '2rem';
            content.style.borderRadius = '8px';
            content.style.minWidth = '400px';
            content.style.color = 'white';
            content.style.maxHeight = '80vh'; content.style.overflowY = 'auto';
            content.innerHTML = html;

            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        function closeModal() {
            const m = document.getElementById('reportModal');
            if (m) m.remove();
        }

        async function loadConsultations() {
            const res = await apiFetch("/consultations/");
            const cons = await res.json();

            const div = document.getElementById('consultationList');
            div.innerHTML = "";
            cons.forEach(c => {
                const item = document.createElement('div');
                item.className = "patient-card";
                const timeStr = c.appointment_time ? new Date(c.appointment_time).toLocaleString() : "No time requested";
                item.innerHTML = `
                    Patient ID: ${c.patient_id} - Status: <strong>${c.status}</strong>
                    <br>Requested Appointment: <strong>${timeStr}</strong>
                    <br>Notes: ${c.notes || 'None'}
                    <br>
                    ${c.status === 'pending' ? `
                        <button class="btn action-btn" onclick="setStatus(${c.id}, 'accepted')">Accept</button>
                        <button class="btn action-btn" onclick="setStatus(${c.id}, 'rejected')">Reject</button>
                    ` : ''}
                `;
                div.appendChild(item);
            });
        }

        async function setStatus(cid, status) {
            await apiFetch(`/consultations/${cid}/status`, {
                method: "PUT",
                body: JSON.stringify({ status })
            });
            loadConsultations();
        }

        async function loadRequests() {
            const res = await apiFetch("/doctors/requests/pending");
            if (!res.ok) return;
            const reqs = await res.json();

            const div = document.getElementById('requestList');
            div.innerHTML = "";
            if (reqs.length === 0) div.innerHTML = "<p>No pending requests.</p>";

            reqs.forEach(r => {
                const item = document.createElement('div');
                item.className = "patient-card";
                item.innerHTML = `
                    Request #${r.id} from Patient ID: ${r.patient_id}
                    <button class="btn action-btn" onclick="acceptRequest(${r.id})">Accept</button>
                `;
                div.appendChild(item);
            });
        }

        async function acceptRequest(rid) {
            const res = await apiFetch(`/doctors/requests/${rid}/accept`, { method: "POST" });
            if (res.ok) {
                alert("Patient Accepted!");
                loadRequests();
                loadPatients();
            } else {
                alert("Failed to accept");
            }
        }

        let isOnline = false;
        async function toggleStatus() {
            isOnline = !isOnline;
            const res = await apiFetch(`/doctors/me/status?status=${isOnline}`, { method: "POST" });
            if (res.ok) {
                updateStatusUI();
            }
        }

        function updateStatusUI() {
            const span = document.getElementById('docStatus');
            const btn = document.getElementById('btnStatus');
            span.textContent = isOnline ? "Online" : "Offline";
            span.style.color = isOnline ? "green" : "gray";
            btn.textContent = isOnline ? "Go Offline" : "Go Online";
        }

        // ---------------------------------------------------------
        // MEANING: Chat Logic.
        // EXPLAIN: "Handle WebSocket and Message History."
        // ---------------------------------------------------------
        let currentChatPartnerId = null;

        async function changeChatPartner() {
            const val = document.getElementById('chatRecipient').value;
            currentChatPartnerId = val ? parseInt(val) : null;
            document.getElementById('chatBox').innerHTML = "";
            if (currentChatPartnerId) loadChatHistory();
        }

        async function loadChatHistory() {
            if (!currentChatPartnerId) return;
            const res = await apiFetch(`/chats/history/${currentChatPartnerId}`);
            if (res.ok) {
                const msgs = await res.json();
                const box = document.getElementById('chatBox');
                box.innerHTML = "";
                msgs.forEach(m => {
                    const div = document.createElement('div');
                    const isMe = m.sender_id === userId;
                    div.className = isMe ? 'msg me' : 'msg other';
                    div.textContent = (isMe ? "Me: " : "Them: ") + m.message;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            }
        }

        function setupWebSocket() {
            ws = new WebSocket(`ws://127.0.0.1:8000/chats/ws/${userId}`);
            ws.onmessage = function (event) {
                const text = event.data;
                const box = document.getElementById('chatBox');
                const div = document.createElement('div');
                div.className = 'msg other';
                div.textContent = text;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            };
        }

        async function sendChat() {
            if (!currentChatPartnerId) {
                alert("Select a patient first.");
                return;
            }
            const input = document.getElementById('chatMsg');
            const txt = input.value;
            if (!txt) return;

            await apiFetch("/chats/", {
                method: "POST",
                body: JSON.stringify({ recipient_id: currentChatPartnerId, message: txt })
            });

            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = 'msg me';
            div.textContent = "Me: " + txt;
            box.appendChild(div);
            input.value = "";
        }

        init();
    </script>
</body>

</html>