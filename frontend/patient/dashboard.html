<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Patient Dashboard - Marutha Support</title>
    
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <header>
        <h1>Patient Dashboard</h1>
        <nav>
            <span id="userName" style="margin-right: 1rem; font-weight: bold;"></span>
            <button onclick="logout()" class="btn" style="background: #e74c3c;">Logout</button>
        </nav>
    </header>

    <div class="container">
        <div id="loading">Loading...</div>

        <div id="content" style="display:none;">
            
            <div class="card">
                <h2>My Profile</h2>
                <p><strong>Name:</strong> <span id="pName"></span></p>
                <p><strong>Age:</strong> <span id="pAge"></span></p>
                <p><strong>Stage:</strong> <span id="pStage" style="color: var(--primary); font-weight: bold;"></span>
                </p>

                <div id="stageChart" style="margin-top: 1rem; padding: 1rem; border: 1px dashed rgba(255,255,255,0.3);">
                    <h3>Stage History</h3>
                    <ul id="stageList"></ul>
                </div>

                <div style="margin-top: 1rem;">
                    <h3>Assigned Volunteer</h3>
                    <p id="volInfo">None</p>
                </div>
            </div>

            
            <div class="card" style="margin-top: 1rem;">
                <h2>Daily Vitals Check-in</h2>
                <div class="form-group">
                    <label>Pain Level (1-10):</label>
                    <input type="number" id="vitalPain" min="1" max="10" value="5"
                        style="width: 60px; padding: 0.5rem;">
                </div>
                <div class="form-group">
                    <label>Mood:</label>
                    <select id="vitalMood" style="padding: 0.5rem;">
                        <option value="Happy">Happy</option>
                        <option value="Calm">Calm</option>
                        <option value="Neutral" selected>Neutral</option>
                        <option value="Sad">Sad</option>
                        <option value="Anxious">Anxious</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" id="vitalNotes" placeholder="Any additional notes?"
                        style="width: 100%; padding: 0.5rem;">
                </div>
                <button onclick="logVitals()" class="btn" style="background: var(--secondary);">Log Vitals</button>
            </div>

            <div class="card">
                <h2>Online Doctors</h2>
                <div id="onlineDoctorsList"></div>
            </div>

            <div class="dashboard-grid">
                
                <div class="card">
                    <h2>Medical Reports</h2>
                    <ul id="reportList"></ul>

                    <h3 style="margin-top: 1rem;">Upload Report</h3>
                    <form id="uploadForm">
                        <div class="form-group">
                            <input type="text" id="repTitle" placeholder="Report Title" required>
                        </div>
                        <div class="form-group">
                            <input type="file" id="repFile" required>
                        </div>
                        <button type="submit" class="btn">Upload</button>
                    </form>
                </div>

                
                <div class="card">
                    <h2>Consultation</h2>
                    <div id="consultationSection">
                        <p>Please assign a doctor from the "Online Doctors" list first.</p>
                    </div>

                    <div id="consultationStatus" style="margin-top: 1rem;"></div>

                    <h2 style="margin-top: 2rem;">Support Chat</h2>
                    <div class="form-group">
                        <label>Chat with:</label>
                        <select id="chatRecipient" onchange="changeChatPartner()" style="padding: 0.5rem;">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="chat-box" id="chatBox"></div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="chatMsg" placeholder="Type a message..."
                            style="flex:1; padding: 0.5rem;">
                        <button onclick="sendChat()" class="btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        let patientId = null;
        let userId = null;
        let ws = null;

        // ---------------------------------------------------------
        // MEANING: Initialization.
        // EXPLAIN: "Load profile, check auth, connect basics."
        // ---------------------------------------------------------
        async function init() {
            const user = await checkAuth();
            if (!user || user.role !== 'patient') {
                window.location.href = "../login.html";
                return;
            }
            userId = user.id;
            document.getElementById('userName').textContent = user.email;

            // Find my patient profile
            const res = await apiFetch("/patients/");
            const patients = await res.json();
            const myProfile = patients.find(p => p.user_id === userId);

            if (myProfile) {
                patientId = myProfile.id;
                await renderProfile(myProfile);
                loadReports();
                loadStages();
                loadOnlineDoctors();
                loadChatPartners(myProfile);
                setupWebSocket(); // Chat

                // Consultation Button Logic
                const conDiv = document.getElementById('consultationSection');
                if (myProfile.doctor_id) {
                    conDiv.innerHTML = `
                        <p>Request an appointment with your doctor.</p>
                        <input type="datetime-local" id="appointTime" style="padding:0.5rem; margin-right:0.5rem;">
                        <button onclick="requestConsultation()" class="btn">Request Consultation</button>
                    `;
                } else {
                    conDiv.innerHTML = '<p class="text-danger">You must have an assigned doctor to request consultation. Please request one from the Online Doctors list.</p>';
                }
            } else {
                alert("Profile not found. Please contact admin.");
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        async function logVitals() {
            const pain = document.getElementById('vitalPain').value;
            const mood = document.getElementById('vitalMood').value;
            const notes = document.getElementById('vitalNotes').value;

            if (!pain || !mood) { alert("Please fill pain and mood."); return; }

            await apiFetch("/vitals/", {
                method: "POST",
                body: JSON.stringify({
                    pain_level: parseInt(pain),
                    mood: mood,
                    notes: notes
                })
            });
            alert("Vitals Logged! Thank you.");
            document.getElementById('vitalNotes').value = "";
        }

        async function renderProfile(p) {
            document.getElementById('pName').textContent = p.name;
            document.getElementById('pAge').textContent = p.age;
            document.getElementById('pStage').textContent = p.stage.toUpperCase();

            if (p.volunteer_id) {
                const vRes = await apiFetch(`/volunteers/${p.volunteer_id}`);
                const vol = await vRes.json();
                document.getElementById('volInfo').textContent = `${vol.name}`;
            }
        }

        let currentChatPartnerId = null;

        // ---------------------------------------------------------
        // MEANING: Load Chat Options.
        // EXPLAIN: "Populate dropdown with assigned doctor and volunteer."
        // ---------------------------------------------------------
        async function loadChatPartners(p) {
            const sel = document.getElementById('chatRecipient');

            if (p.doctor_id) {
                const dRes = await apiFetch(`/doctors/${p.doctor_id}`);
                const doc = await dRes.json();
                const opt = document.createElement('option');
                opt.value = doc.user_id;
                opt.textContent = `Doctor: ${doc.name}`;
                sel.appendChild(opt);
            }

            if (p.volunteer_id) {
                const vRes = await apiFetch(`/volunteers/${p.volunteer_id}`);
                const vol = await vRes.json();
                const opt = document.createElement('option');
                opt.value = vol.user_id;
                opt.textContent = `Volunteer: ${vol.name}`;
                sel.appendChild(opt);
            }
        }

        async function changeChatPartner() {
            const val = document.getElementById('chatRecipient').value;
            currentChatPartnerId = val ? parseInt(val) : null;
            document.getElementById('chatBox').innerHTML = "";
            if (currentChatPartnerId) {
                loadChatHistory();
            }
        }

        async function loadChatHistory() {
            if (!currentChatPartnerId) return;
            const res = await apiFetch(`/chats/history/${currentChatPartnerId}`);
            if (res.ok) {
                const msgs = await res.json();
                const box = document.getElementById('chatBox');
                box.innerHTML = "";
                msgs.forEach(m => {
                    const div = document.createElement('div');
                    const isMe = m.sender_id === userId;
                    div.className = isMe ? 'msg me' : 'msg other';
                    div.textContent = (isMe ? "Me: " : "Them: ") + m.message;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            }
        }

        function setupWebSocket() {
            ws = new WebSocket(`ws://127.0.0.1:8000/chats/ws/${userId}`);
            ws.onmessage = function (event) {
                const text = event.data;
                const box = document.getElementById('chatBox');
                const div = document.createElement('div');
                div.className = 'msg other';
                div.textContent = text;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            };
        }

        async function sendChat() {
            if (!currentChatPartnerId) {
                alert("Select a recipient first.");
                return;
            }
            const input = document.getElementById('chatMsg');
            const txt = input.value;
            if (!txt) return;

            await apiFetch("/chats/", {
                method: "POST",
                body: JSON.stringify({ recipient_id: currentChatPartnerId, message: txt })
            });

            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.className = 'msg me';
            div.textContent = "Me: " + txt;
            box.appendChild(div);
            input.value = "";
        }

        async function loadOnlineDoctors() {
            const res = await apiFetch("/patients/online/doctors");
            const docs = await res.json();
            const div = document.getElementById('onlineDoctorsList');
            div.innerHTML = "";

            if (docs.length === 0) div.innerHTML = "<p>No doctors online.</p>";

            docs.forEach(d => {
                const item = document.createElement('div');
                item.className = "patient-card";
                item.innerHTML = `
                    <strong>${d.name}</strong> (${d.specialty})
                    <button class="btn action-btn" onclick="sendRequest(${d.id})">Request</button>
                `;
                div.appendChild(item);
            });
        }

        async function sendRequest(did) {
            const res = await apiFetch(`/patients/request_doctor/${did}`, { method: "POST" });
            const data = await res.json();
            alert(data.message);
        }

        // ---------------------------------------------------------
        // MEANING: Load File List.
        // EXPLAIN: "Show uploaded reports."
        // ---------------------------------------------------------
        async function loadReports() {
            const res = await apiFetch(`/reports/patient/${patientId}`);
            const reports = await res.json();
            const list = document.getElementById('reportList');
            list.innerHTML = "";
            reports.forEach(r => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${r.title}</strong> (${new Date(r.created_at).toLocaleDateString()})`;
                list.appendChild(li);
            });
        }

        async function loadStages() {
            const res = await apiFetch(`/patients/${patientId}/stages`);
            const data = await res.json();
            const list = document.getElementById('stageList');
            data.history.forEach(h => {
                const li = document.createElement('li');
                li.textContent = `${h.date}: ${h.stage}`;
                list.appendChild(li);
            });
            const li = document.createElement('li');
            li.textContent = `Current: ${data.current}`;
            li.style.fontWeight = 'bold';
            list.appendChild(li);
        }

        // ---------------------------------------------------------
        // MEANING: Handle File Upload.
        // EXPLAIN: "Send file using FormData."
        // ---------------------------------------------------------
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('repTitle').value;
            const file = document.getElementById('repFile').files[0];
            const formData = new FormData();
            formData.append('patient_id', patientId);
            formData.append('title', title);
            formData.append('file', file);
            await apiFetch("/reports/upload", { method: "POST", body: formData });
            alert("Uploaded!");
            loadReports();
        });

        async function requestConsultation() {
            const timeVal = document.getElementById('appointTime').value;
            if (!timeVal) {
                alert("Please select a preferred date and time.");
                return;
            }

            const res = await apiFetch(`/patients/${patientId}`);
            const p = await res.json();
            await apiFetch("/consultations/", {
                method: "POST",
                body: JSON.stringify({
                    doctor_id: p.doctor_id,
                    notes: "Requested via Dashboard",
                    appointment_time: timeVal
                })
            });
            alert("Consultation Requested");
        }

        init();
    </script>
</body>

</html>